<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта на лечебни заведения в България</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Стил за страницата -->
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .sidebar h2 {
            font-size: 16pt;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .sidebar select {
            width: 100%;
            padding: 10px;
            font-size: 12pt;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: 'Times New Roman', Times, serif;
        }
        #map {
            flex: 1;
            height: 100%;
        }
        h1 {
            text-align: center;
            font-size: 14pt;
            font-weight: bold;
            padding: 20px;
            background-color: #2c3e50;
            color: white;
            margin: 0;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            font-size: 12pt;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 300px;
            text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress {
            height: 20px;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .leaflet-popup-content {
            font-family: 'Times New Roman', Times, serif;
            font-size: 12pt;
            line-height: 1.5;
        }
        .leaflet-popup-content b {
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <h1>Карта на лечебни заведения за болнична помощ в България</h1>
    <div class="container">
        <div class="sidebar">
            <h2>Филтри</h2>
            <select id="oblast-filter">
                <option value="">Всички области</option>
            </select>
        </div>
        <div id="map"></div>
        <div id="loading">
            <div class="spinner"></div>
            <span id="loading-text">Зареждане на данни от CSV...</span>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- PapaParse за CSV парсинг -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // Инициализация на картата
        const map = L.map('map').setView([42.7339, 25.4858], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Създаване на клъстерна група
        const markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: true,
            iconCreateFunction: function(cluster) {
                return L.divIcon({
                    html: `<div style="background-color: #3498db; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 14pt;">${cluster.getChildCount()}</div>`,
                    className: 'custom-cluster',
                    iconSize: [40, 40]
                });
            }
        });

        // Функция за геокодиране през публичен CORS прокси
        async function geocodeAddress(address, city, oblast) {
            if (!city || city === 'undefined' || city.trim() === '') {
                city = oblast; // Fallback to oblast if city is missing or undefined
            }
            const cacheKey = `geocode_${address}_${city}_${oblast}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                return JSON.parse(cached);
            }
            try {
                const query = encodeURIComponent(`${address}, ${city}, ${oblast}, Bulgaria`);
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${query}`;
                const response = await fetch(`${proxyUrl}${nominatimUrl}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'User-Agent': 'CourseProject/1.0 (your_email@example.com)' // Replace with your email
                    }
                });
                if (!response.ok) {
                    throw new Error(`Proxy responded with status ${response.status}`);
                }
                const data = await response.json();
                if (data.length > 0) {
                    const coords = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                    localStorage.setItem(cacheKey, JSON.stringify(coords));
                    return coords;
                }
                console.warn(`Няма намерени координати за: ${address}, ${city}, ${oblast}`);
                return null;
            } catch (error) {
                console.error(`Грешка при геокодиране на ${address}:`, error);
                return null;
            }
        }

        // Функция за добавяне на маркер с изчакване
        async function addMarkerWithDelay(hospital, index, total) {
            await new Promise(resolve => setTimeout(resolve, index * 1100)); // 1.1 сек. закъснение
            const coords = await geocodeAddress(hospital.Адрес, hospital.Населено_място, hospital.Област);
            if (coords) {
                const marker = L.marker([coords.lat, coords.lng], {
                    icon: L.divIcon({
                        html: '<i class="fa fa-hospital" style="color: #e74c3c; font-size: 24px;"></i>',
                        className: 'custom-marker',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                });
                marker.bindPopup(`
                    <b>${hospital.Наименование || 'N/A'}</b><br>
                    Област: ${hospital.Област || 'N/A'}<br>
                    Община: ${hospital.Община || 'N/A'}<br>
                    Населено място: ${hospital.Населено_място || 'N/A'}<br>
                    Адрес: ${hospital.Адрес || 'N/A'}<br>
                    Управител: ${hospital.Управител || 'N/A'}<br>
                    Телефон: ${hospital.Телефон || 'N/A'}<br>
                    Клинични пътеки: ${hospital.Клинични_пътеки || 'N/A'}
                `);
                markers.addLayer(marker);
            }
            // Обновяване на прогрес бара
            const progressPercent = ((index + 1) / total * 100).toFixed(2);
            document.getElementById('progress').style.width = `${progressPercent}%`;
            document.getElementById('loading-text').textContent = `Геокодиране на адрес ${index + 1} от ${total} (${progressPercent}%)...`;
        }

        // Зареждане и парсинг на CSV
        fetch('hospitals.csv') // Update to your GitHub repo path, e.g., '/your-repo/proba/hospitals.csv'
            .then(response => {
                if (!response.ok) throw new Error('CSV файлът не е намерен. Уверете се, че hospitals.csv е в същата папка или в GitHub репозиториото.');
                return response.text();
            })
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async function(results) {
                        const hospitals = results.data;
                        // Валидиране на данните
                        hospitals.forEach(hospital => {
                            hospital.Населено_място = (hospital.Населено_място && hospital.Населено_място.trim() !== '') ? hospital.Населено_място : hospital.Област;
                        });
                        document.getElementById('loading-text').textContent = `Геокодиране на ${hospitals.length} адреса...`;

                        // Попълване на филтъра по области
                        const oblasts = [...new Set(hospitals.map(h => h.Област))].sort();
                        const filterSelect = document.getElementById('oblast-filter');
                        oblasts.forEach(oblast => {
                            const option = document.createElement('option');
                            option.value = oblast;
                            option.textContent = oblast;
                            filterSelect.appendChild(option);
                        });

                        // Функция за обновяване на маркерите
                        function updateMarkers(filterOblast) {
                            markers.clearLayers();
                            hospitals.forEach(hospital => {
                                if (hospital.coords && (!filterOblast || hospital.Област === filterOblast)) {
                                    const marker = L.marker([hospital.coords.lat, hospital.coords.lng], {
                                        icon: L.divIcon({
                                            html: '<i class="fa fa-hospital" style="color: #e74c3c; font-size: 24px;"></i>',
                                            className: 'custom-marker',
                                            iconSize: [30, 30],
                                            iconAnchor: [15, 30]
                                        })
                                    });
                                    marker.bindPopup(`
                                        <b>${hospital.Наименование || 'N/A'}</b><br>
                                        Област: ${hospital.Област || 'N/A'}<br>
                                        Община: ${hospital.Община || 'N/A'}<br>
                                        Населено място: ${hospital.Населено_място || 'N/A'}<br>
                                        Адрес: ${hospital.Адрес || 'N/A'}<br>
                                        Управител: ${hospital.Управител || 'N/A'}<br>
                                        Телефон: ${hospital.Телефон || 'N/A'}<br>
                                        Клинични пътеки: ${hospital.Клинични_пътеки || 'N/A'}
                                    `);
                                    markers.addLayer(marker);
                                }
                            });
                            map.addLayer(markers);
                            if (markers.getLayers().length > 0) {
                                map.fitBounds(markers.getBounds());
                            }
                        }

                        // Геокодиране на адресите
                        for (let i = 0; i < hospitals.length; i++) {
                            hospitals[i].coords = await geocodeAddress(hospitals[i].Адрес, hospitals[i].Населено_място, hospitals[i].Област);
                            await addMarkerWithDelay(hospitals[i], i, hospitals.length);
                        }

                        // Инициално зареждане на всички маркери
                        updateMarkers('');

                        // Слушател за филтъра
                        filterSelect.addEventListener('change', function() {
                            updateMarkers(this.value);
                        });

                        // Скриване на зареждащия екран
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('map').style.display = 'block';
                    },
                    error: function(error) {
                        console.error('Грешка при парсинг на CSV:', error);
                        document.getElementById('loading').innerHTML = 'Грешка при зареждане на CSV: ' + error.message;
                    }
                });
            })
            .catch(error => {
                console.error('Грешка при fetch на CSV:', error);
                document.getElementById('loading').innerHTML = 'Грешка: ' + error.message + '<br>Уверете се, че hospitals.csv е достъпен и стартирайте локален сървър (напр. python -m http.server).';
            });
    </script>
</body>
</html>