<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта на лечебни заведения в България</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* Same styles as above */
    </style>
</head>
<body>
    <h1>Карта на лечебни заведения за болнична помощ в България</h1>
    <div class="container">
        <div class="sidebar">
            <h2>Филтри</h2>
            <select id="oblast-filter">
                <option value="">Всички области</option>
            </select>
        </div>
        <div id="map"></div>
        <div id="loading">
            <div class="spinner"></div>
            <span id="loading-text">Зареждане на данни от CSV...</span>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        const map = L.map('map').setView([42.7339, 25.4858], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: true,
            iconCreateFunction: function(cluster) {
                return L.divIcon({
                    html: `<div style="background-color: #3498db; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 14pt;">${cluster.getChildCount()}</div>`,
                    className: 'custom-cluster',
                    iconSize: [40, 40]
                });
            }
        });

        fetch('hospitals_with_coords.csv') // Update to '/your-repo/proba/hospitals_with_coords.csv' for GitHub
            .then(response => {
                if (!response.ok) throw new Error('CSV файлът не е намерен. Уверете се, че hospitals_with_coords.csv е в репозиториото.');
                return response.text();
            })
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const hospitals = results.data;
                        document.getElementById('loading-text').textContent = `Зареждане на ${hospitals.length} лечебни заведения...`;

                        const oblasts = [...new Set(hospitals.map(h => h.Област))].sort();
                        const filterSelect = document.getElementById('oblast-filter');
                        oblasts.forEach(oblast => {
                            const option = document.createElement('option');
                            option.value = oblast;
                            option.textContent = oblast;
                            filterSelect.appendChild(option);
                        });

                        function updateMarkers(filterOblast) {
                            markers.clearLayers();
                            hospitals.forEach(hospital => {
                                if (hospital.lat && hospital.lng && !isNaN(hospital.lat) && !isNaN(hospital.lng)) {
                                    if (!filterOblast || hospital.Област === filterOblast) {
                                        const marker = L.marker([parseFloat(hospital.lat), parseFloat(hospital.lng)], {
                                            icon: L.divIcon({
                                                html: '<i class="fa fa-hospital" style="color: #e74c3c; font-size: 24px;"></i>',
                                                className: 'custom-marker',
                                                iconSize: [30, 30],
                                                iconAnchor: [15, 30]
                                            })
                                        });
                                        marker.bindPopup(`
                                            <b>${hospital.Наименование || 'N/A'}</b><br>
                                            Област: ${hospital.Област || 'N/A'}<br>
                                            Община: ${hospital.Община || 'N/A'}<br>
                                            Населено място: ${hospital.Населено_място || 'N/A'}<br>
                                            Адрес: ${hospital.Адрес || 'N/A'}<br>
                                            Управител: ${hospital.Управител || 'N/A'}<br>
                                            Телефон: ${hospital.Телефон || 'N/A'}<br>
                                            Клинични пътеки: ${hospital.Клинични_пътеки || 'N/A'}
                                        `);
                                        markers.addLayer(marker);
                                    }
                                }
                            });
                            map.addLayer(markers);
                            if (markers.getLayers().length > 0) {
                                map.fitBounds(markers.getBounds());
                            }
                        }

                        updateMarkers('');

                        filterSelect.addEventListener('change', function() {
                            updateMarkers(this.value);
                        });

                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('map').style.display = 'block';
                    },
                    error: function(error) {
                        console.error('Грешка при парсинг на CSV:', error);
                        document.getElementById('loading').innerHTML = 'Грешка при зареждане на CSV: ' + error.message;
                    }
                });
            })
            .catch(error => {
                console.error('Грешка при fetch на CSV:', error);
                document.getElementById('loading').innerHTML = 'Грешка: ' + error.message + '<br>Уверете се, че hospitals_with_coords.csv е в репозиториото.';
            });
    </script>
</body>
</html>