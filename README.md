# Data Modeling: Национален регистър на лечебните заведения в България

## 1. Избор на регистър и обосновка

### 1.1 Избран регистър
**Регистър на лечебните заведения с договор с НЗОК**

**Източник:** https://services.nhif.bg/references/lists/hospital.xhtm

### 1.2 Нормативна уредба

Регистърът е държавно регулиран съгласно:

1. **Закон за здравното осигуряване (ЗЗО)**
   - Чл. 55, ал. 1 - НЗОК сключва договори с лечебни заведения
   - Чл. 58 - Условия за сключване на договори

2. **Наредба № 10 от 18.05.2022 г. за определяне на необходимите документи за сключване на договори между НЗОК и изпълнителите на медицинска помощ**

3. **Закон за лечебните заведения (ЗЛЗ)**
   - Чл. 5 - Видове лечебни заведения
   - Чл. 8 - Регистрация на лечебни заведения

### 1.3 Публичност и достъпност

✅ **Публичен:** Регистърът е публично достъпен на уеб страницата на НЗОК  
✅ **Електронен:** Достъпен онлайн в HTML формат  
⚠️ **Формат:** Не е публикуван на data.egov.bg в отворен машинночетим формат

---

## 2. Описание на модела на данни

### 2.1 Защо този регистър?

**Обществена значимост:**
- 468 лечебни заведения обслужват милиони граждани
- Критична информация за достъп до здравни услуги
- Необходимост от географска локализация и публична достъпност

**Проблеми с настоящия формат:**
- HTML таблица - не е машинночетима
- Липса на геолокация (координати)
- Не е в отворен формат (CSV, JSON, XML)
- Непълни адресни данни

**Възможности за подобрение:**
- Геокодиране на адресите
- Стандартизация на данните
- Публикуване в отворен формат
- API достъп за външни приложения

---

## 3. Структура на модела на данни

### 3.1 Основни колони (оригинални данни)

| Колона | Тип данни | Описание | Задължителност | Пример |
|--------|-----------|----------|----------------|--------|
| `id` | Integer | Уникален идентификатор | Задължително | 1 |
| `Наименование` | String(500) | Пълно наименование на лечебното заведение | Задължително | "МБАЛ Св. Георги ЕАД" |
| `Област` | String(100) | Област по административно деление | Задължително | "София - област" |
| `Община` | String(100) | Община | Задължително | "ПЛОВДИВ" |
| `Населено място` | String(100) | Град/село | Задължително | "Пловдив" |
| `Адрес` | String(200) | Пълен адрес | Задължително | "бул. Пещерско шосе 66" |
| `Управител` | String(200) | Имена на управители | Незадължително | "Д-Р ИВАН ПЕТРОВ" |
| `Телефон` | String(100) | Телефонни номера | Незадължително | "032/602345" |

### 3.2 Разширени колони (добавени при обработка)

| Колона | Тип данни | Описание | Задължителност | Пример |
|--------|-----------|----------|----------------|--------|
| `lat` | Decimal(10,7) | Географска ширина (WGS84) | Незадължително | 42.1354079 |
| `lng` | Decimal(10,7) | Географска дължина (WGS84) | Незадължително | 24.7452904 |
| `quality_score` | Integer(0-100) | Качество на геокодирането | Незадължително | 95 |
| `provider` | String(50) | Източник на координатите | Незадължително | "nominatim_free" |
| `display_name` | String(500) | Пълен адрес от геокодера | Незадължително | "МБАЛ Свети Георги..." |
| `street_number` | String(20) | Извлечен номер на сграда | Незадължително | "66" |
| `street_name_clean` | String(200) | Почистено име на улица | Незадължително | "Пещерско шосе" |
| `search_query` | String(500) | Оптимизирана заявка за търсене | Незадължително | "бул. Пещерско шосе 66, Пловдив, България" |
| `last_updated` | DateTime | Дата на последна актуализация | Задължително | "2025-10-27T14:30:00" |
| `data_source_url` | String(500) | URL на оригиналния източник | Задължително | "https://services.nhif.bg/..." |

### 3.3 Metadata колони (за управление на данни)

| Колона | Тип данни | Описание |
|--------|-----------|----------|
| `created_at` | DateTime | Дата на създаване на записа |
| `updated_at` | DateTime | Дата на последна промяна |
| `data_version` | String(20) | Версия на данните |
| `validation_status` | Enum | статус (validated, pending, invalid) |

---

## 4. Формат на данните

### 4.1 Структура на редовете

Всеки **ред** представлява:
- **1 лечебно заведение** с **1 адрес**
- Ако заведение има множество адреси → множество редове
- Пример: "МБАЛ Авис Медика ООД" има 3 адреса → 3 реда

### 4.2 Примерни записи

```csv
id,Наименование,Област,Община,Населено място,Адрес,Управител,Телефон,lat,lng,quality_score,provider,last_updated
1,МБАЛ Св. Георги ЕАД,Пловдив,ПЛОВДИВ,Пловдив,бул. Пещерско шосе 66,"Д-Р ИВАН ПЕТРОВ","032/602345",42.1354079,24.7452904,95,nominatim_free,2025-10-27T14:30:00
2,УМБАЛ Александровска ЕАД,София,СОФИЯ,София,бул. Георги Софийски 1,"ПРОФ. Д-Р ВАНЯ ЙОРДАНОВА","02/9230719",42.6977082,23.3218675,100,nominatim_free,2025-10-27T14:30:00
3,ДКЦ Здраве ЕООД,Варна,ВАРНА,Варна,ул. Цар Симеон I 32,"Д-Р МАРИЯ ДИМИТРОВА","052/612345",43.2140504,27.9147333,85,nominatim_free,2025-10-27T14:30:00
```

### 4.3 Отворени формати

Данните са публикувани в следните отворени формати съгласно Open Definition (https://opendefinition.org/ofd/):

1. **CSV (Comma-Separated Values)**
   - ✅ Отворен стандарт
   - ✅ Машинночетим
   - ✅ Универсална съвместимост
   - Файл: `hospitals_ultimate_coords.csv`

2. **JSON (JavaScript Object Notation)**
   - ✅ Структуриран формат
   - ✅ API-ready
   - Може да се генерира от CSV

3. **GeoJSON (за географски данни)**
   - ✅ ISO стандарт за географски данни
   - ✅ Съвместим с GIS системи
   - Може да се генерира от координатите

---

## 5. Качество на данните

### 5.1 Качествени нива на геокодиране

Използваме **quality_score (0-100)** за оценка на точността:

| Ниво | Score | Критерии | Брой | Процент |
|------|-------|----------|------|---------|
| ★★★ Отлично | 80-100 | Точен адрес с номер, проверен град | 129 | 42.3% |
| ★★ Добро | 60-79 | Адрес без номер или приблизителен | 32 | 10.5% |
| ★ Приемливо | 40-59 | Ниво квартал/район | 144 | 47.2% |
| ✗ Липсва | N/A | Не е намерен в геокодери | 163 | 34.8% |

**Общо с координати:** 305 от 468 (65.2%)

### 5.2 Алгоритъм за скориране

```python
score = 0

# Точно съвпадение на град (30 точки)
if exact_city_match: score += 30

# Номер на сграда (40 точки)
if house_number_exact: score += 40
elif house_number_partial: score += 20

# Име на улица (25 точки)
if street_name_exact: score += 25
elif street_name_partial: score += 15

# Тип на адреса (15 точки)
if has_house_number_field: score += 8
if has_road_field: score += 7

# Прецизност на координати (10 точки)
if decimal_places >= 7: score += 10
elif decimal_places >= 5: score += 5

# OSM тип (5 точки)
if osm_type == 'node': score += 5  # точка
elif osm_type == 'building': score += 5
```

---

## 6. Процес на обработка на данните

### 6.1 Pipeline за обработка

```
1. EXTRACTION (Извличане)
   ↓
   HTML таблица от НЗОК
   
2. NORMALIZATION (Нормализация)
   ↓
   - Премахване на излишни символи (№, ет., вх.)
   - Стандартизация на съкращения (ул., бул., жк)
   - Коригиране на грешки в данните
   
3. ENRICHMENT (Обогатяване)
   ↓
   - Извличане на номер на сграда
   - Извличане на име на улица
   - Създаване на search queries
   
4. GEOCODING (Геокодиране)
   ↓
   - Nominatim (OpenStreetMap)
   - Overpass API (POI търсене)
   - Multi-strategy подход
   
5. VALIDATION (Валидация)
   ↓
   - Проверка на координати в България
   - Проверка за съответствие град-координати
   - Quality scoring
   
6. EXPORT (Експорт)
   ↓
   - CSV файлове
   - Categorization по качество
   - Визуализация на карта
```

### 6.2 Използвани технологии

**Програмен език:**
- Python 3.13

**Библиотеки:**
- pandas - обработка на табличи данни
- requests - HTTP заявки
- re - регулярни изрази

**API-та:**
- Nominatim (OpenStreetMap) - безплатно геокодиране
- Overpass API - търсене на POI в OSM

**Визуализация:**
- Leaflet.js - интерактивна карта
- OpenStreetMap tiles - картова основа

---

## 7. Необходими нормативни изменения

### 7.1 Проблеми с настоящата уредба

**1. Липса на задължение за публикуване в отворен формат**
- Регистърът е достъпен само като HTML таблица
- Не е публикуван на data.egov.bg
- Липсва API достъп
- **Нарушава:** ЗЕУ, чл. 12 за отворени данни

**2. Непълни адресни данни**
- Не се изискват географски координати
- Формат на адрес не е стандартизиран
- Липсва валидация на адреси
- **Липсва в:** ЗЗО чл. 58, ЗЛЗ чл. 8

**3. Липса на автоматична актуализация**
- Не е ясно колко често се обновява регистърът
- Липсва информация за версиониране
- Не се проследяват промени

**4. Здравните данни не са високостойностни**
- Липсват в Приложение I към ЗЕУ
- Не се предоставят безплатно и отворено
- Не отговарят на EU Directive (EU) 2019/1024

### 7.2 Предложени нормативни изменения

#### Изменение 1: В Закон за здравното осигуряване (ЗЗО)

**Нов чл. 55а - Публичен регистър в отворен формат:**
> (1) НЗОК създава и поддържа публичен регистър на лечебните заведения с договор в отворен машинночетим формат.
>
> (2) Регистърът по ал. 1 се публикува на Портала за отворени данни (data.egov.bg) в следните формати: CSV, JSON, XML.
>
> (3) Регистърът съдържа минимум следните данни:
> - Наименование, ЕИК/БУЛСТАТ, вид на лечебното заведение
> - Пълен адрес (населено място, улица, номер)
> - Географски координати (WGS84, latitude/longitude)
> - Управител, контактни данни
> - Дата на последна актуализация
>
> (4) Регистърът се актуализира ежемесечно, не по-късно от 5-то число на месеца.
>
> (5) Редът за водене на регистъра се определя с наредба на министъра на здравеопазването.

**Изм. чл. 58 - Изискване за координати:**
> Нова ал. (4): При сключване на договор лечебното заведение предоставя географски координати на адреса си в координатна система WGS84 с точност минимум 7 десетични знака.

#### Изменение 2: В Закон за лечебните заведения (ЗЛЗ)

**Изм. чл. 8 - Координати при регистрация:**
> (1) НЗОК поддържа публичен регистър на лечебните заведения с договор в отворен машинночетим формат.
>
> (2) Регистърът по ал. 1 се публикува на Портала за отворени данни (data.egov.bg) в следните формати:
> - CSV (Comma-Separated Values)
> - JSON (JavaScript Object Notation)
> - XML (Extensible Markup Language)
>
> (3) Регистърът съдържа минимум следните данни:
> - Наименование на лечебното заведение
> - ЕИК/БУЛСТАТ
> - Вид на лечебното заведение
> - Адрес (населено място, улица, номер)
> - Географски координати (WGS84)
> - Управител
> - Контактни данни
> - Дата на последна актуализация
>
> (4) Регистърът се актуализира ежемесечно, не по-късно от 5-то число на месеца.

#### Изменение 2: В Закон за лечебните заведения

**Изм. чл. 8 - Координати при регистрация:**
> Нова ал. (3): При регистрация на лечебно заведение се посочват географските координати на адреса в координатна система WGS84 с точност минимум 7 десетични знака.
>
> Нова ал. (4): Географските координати по ал. 3 се определят по ред, определен с наредба на министъра на здравеопазването.
>
> Нова ал. (5): Данните по ал. 3 са публични и се публикуват на Портала за отворени данни (data.egov.bg).

#### Изменение 3: В Закон за електронно управление (ЗЕУ)

**Изм. чл. 13 - Високостойностни данни:**
> Нова ал. (5): Здравните данни по Приложение I, раздел "Здравеопазване" се предоставят в отворен формат безплатно чрез Портала за отворени данни (data.egov.bg).

**Доп. Приложение I - Масиви данни с висока стойност:**
> Към Приложение I се добавя:
> 
> **14. Здравеопазване**
> - Регистър на лечебните заведения с договор с НЗОК
> - Регистър на медицинските специалисти
> - Регистър на лекарствените продукти
>
> *Обосновка:* Хармонизация с EU Directive (EU) 2019/1024 относно отворените данни и повторната употреба на информация от обществения сектор.

#### Изменение 4: Нова наредба за стандартизация на адресни данни

**Наредба за стандартизация на адресни данни в здравните регистри**

Чл. 1. Адресните данни в здравните регистри се въвеждат по следния стандарт:
- Населено място (без префикси "ГР.", "С.")
- Тип улица (ул., бул., пл., жк)
- Име на улица
- Номер на сграда
- Географски координати (latitude, longitude в WGS84 с точност минимум 7 десетични знака)

Чл. 2. При въвеждане на адрес се извършва автоматична валидация спрямо:
- Национална база данни адреси (НБДА)
- OpenStreetMap данни
- Координати в границите на България (latitude: 41.0-44.5, longitude: 22.0-29.0)

Чл. 3. Забранено е използването на:
- Неструктурирани описания ("до парка", "до спортна зала")
- Информация за етажи и входове в основния адрес
- Символи като №, #, @ в адресни данни

---

## 8. Внедрени подобрения в проекта

### 8.1 Създадени файлове

| Файл | Описание | Записи |
|------|----------|--------|
| `hospitals_official_cleaned.csv` | Оригинални данни от НЗОК | 468 |
| `hospitals_official_improved.csv` | Нормализирани данни | 468 |
| `hospitals_ultimate_coords.csv` | Пълен модел с координати | 468 |
| `hospitals_excellent.csv` | Високо качество (80-100) | 129 |
| `hospitals_lowconf.csv` | Ниско качество (40-59) | 144 |
| `hospitals_missing.csv` | Без координати | 163 |
| `index.html` | Интерактивна карта | - |

### 8.2 Скриптове за обработка

| Скрипт | Функция |
|--------|---------|
| `improve_data.py` | Нормализация на адреси |
| `ultimate_geocode.py` | Multi-strategy геокодиране |
| `continue_geocoding.py` | Довършване на липсващи |
| `final_summary.py` | Обобщена статистика |

### 8.3 Качествени показатели

**Постигнати резултати:**
- ✅ 65.2% успешно геокодирани адреси (305/468)
- ✅ 42.3% с високо качество (129/305)
- ✅ 100% данни в отворен CSV формат
- ✅ Интерактивна визуализация
- ✅ Цветово кодиране по качество

---

## 9. Използване на данните

### 9.1 Зареждане в Excel/LibreOffice

```bash
Отворете: hospitals_ultimate_coords.csv
Encoding: UTF-8
Delimiter: ,
```

### 9.2 Зареждане в Python

```python
import pandas as pd

df = pd.read_csv('hospitals_ultimate_coords.csv', encoding='utf-8')

# Филтриране само с координати
with_coords = df[df['lat'].notna()]

# Филтриране по качество
excellent = df[df['quality_score'] >= 80]

# Филтриране по област
sofia = df[df['Област'] == 'София']
```

### 9.3 Визуализация на карта

Отворете `index.html` в браузър за да видите:
- Всички 305 болници с координати
- Цветово кодиране по качество
- Филтриране по област
- Clustering на маркери

---

## 10. Препоръки за подобрение

### 10.1 Краткосрочни (1-3 месеца)

1. **Публикуване на data.egov.bg**
   - Качване на CSV файла
   - Добавяне на metadata
   - Автоматична актуализация

2. **Валидация на адреси**
   - Проверка спрямо НБДА
   - Корекция на грешки
   - Добавяне на липсващи номера

3. **Геокодиране на останалите 163**
   - Ръчна проверка
   - Google Geocoding API (платен)
   - Correction от общините

### 10.2 Средносрочни (3-6 месеца)

1. **API за достъп до данни**
   - REST API
   - GraphQL API
   - Реално-време актуализации

2. **Интеграция с други регистри**
   - Национален здравен регистър
   - Търговски регистър (БУЛСТАТ)
   - НБДА (адреси)

3. **Мобилно приложение**
   - Намиране на най-близка болница
   - Навигация
   - Работно време

### 10.3 Дългосрочни (6-12 месеца)

1. **Разширяване на данните**
   - Специалности
   - Работно време
   - Легла
   - Свободни места

2. **Качествени показатели**
   - Оценки на пациенти
   - Времена за чакане
   - Инфекции в болници

3. **Интеграция с електронно здравеопазване**
   - Електронни направления
   - Записване на час
   - Електронни рецепти

---

## 11. Заключение

Проектът демонстрира как **държавен регистър** може да бъде трансформиран в **отворени данни с висока стойност**:

✅ **Отворен формат:** CSV съгласно Open Definition  
✅ **Машинночетим:** Готов за автоматична обработка  
✅ **Географски обогатен:** 65.2% с координати  
✅ **Качествено оценен:** 3-степенна скала (80-100, 60-79, 40-59)  
✅ **Публично достъпен:** GitHub / локални файлове  
✅ **Визуализиран:** Интерактивна карта  

**Нормативните изменения** ще осигурят:
- Задължително публикуване в отворен формат
- Стандартизация на адресни данни
- Добавяне на географски координати
- Редовна актуализация

**Обществената полза:**
- Гражданите намират лечебни заведения по-лесно
- Общините планират здравна инфраструктура
- Изследователите анализират достъп до здравеопазване
- Разработчиците създават приложения

---

## 12. Източници и лицензи

**Оригинални данни:**
- НЗОК: https://services.nhif.bg/references/lists/hospital.xhtm
- Дата на извличане: Октомври 2025

**Геокодиране:**
- OpenStreetMap / Nominatim (ODbL License)
- Overpass API (ODbL License)

**Предложен лиценз за данните:**
- Creative Commons CC-BY 4.0
- Отворени за търговска и нетърговска употреба
- С attribution към НЗОК

**Код:**
- Python скриптове (MIT License)
- HTML/JavaScript (MIT License)

---

**Дата на изготвяне:** 27 октомври 2025  
**Версия:** 1.0  
**Автор:** Data Modeling Project - Hospital Registry
